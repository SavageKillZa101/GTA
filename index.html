<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web GTA - Final Compatibility Fix</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: monospace; }
        #hud { position: absolute; top: 10px; left: 10px; color: #fff; z-index: 10; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; border: 1px solid #444; }
        #weapon-wheel { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 350px; height: 350px; background: radial-gradient(circle, rgba(0,0,0,0.95), transparent); border-radius: 50%; display: none; align-items: center; justify-content: center; z-index: 2000; }
        .weapon-slot { position: absolute; color: #fff; font-weight: bold; cursor: pointer; pointer-events: auto; padding: 20px; transition: 0.2s; background: rgba(255,255,255,0.1); border-radius: 10px; width: 80px; text-align: center; }
        .weapon-slot:hover { background: #ffcc00; color: #000; }
        #v-console { position: absolute; bottom: 0; left: 0; width: 100%; height: 25%; background: rgba(0,0,0,0.9); color: #0f0; overflow-y: auto; display: none; padding: 10px; font-size: 11px; z-index: 3000; border-top: 2px solid #0f0; }
    </style>
</head>
<body>

<div id="v-console"><strong>BONE LIST (Check here for hand name)</strong><hr></div>
<div id="weapon-wheel">
    <div class="weapon-slot" style="top: 0%;" onclick="equip('fist')">FIST</div>
    <div class="weapon-slot" style="right: 0%;" onclick="equip('pistol')">PISTOL</div>
    <div class="weapon-slot" style="bottom: 0%;" onclick="equip('m4')">M4 RIFLE</div>
    <div class="weapon-slot" style="left: 0%;" onclick="equip('rpg')">RPG</div>
</div>

<div id="hud">
    <b style="color:#ffcc00">GTA ENGINE V6</b><br>
    WASD: Move | F: Enter Truck<br>
    TAB: Weapons | =: Debug Log
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

// --- CONFIG ---
const SCALES = { city: 1.0, player: 20.0, truck: 5.0, weapon: 1.5 };
const vConsole = document.getElementById('v-console');
const log = (msg) => { vConsole.innerHTML += `> ${msg}<br>`; vConsole.scrollTop = vConsole.scrollHeight; };

// --- SCENE SETUP ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 20000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Brighter lights to counter the SpecularGlossiness error
scene.add(new THREE.AmbientLight(0xffffff, 3.0));
const sun = new THREE.DirectionalLight(0xffffff, 2.0);
sun.position.set(100, 200, 100);
scene.add(sun);

const loader = new GLTFLoader();
let player, truck, mixer, handBone;
let weaponModels = {};
let isDriving = false;
const keys = {};

// --- LOADING ASSETS ---

// 1. City
loader.load('assets/source/Project.glb', (gltf) => {
    scene.add(gltf.scene);
    log("City loaded. Ignore SpecularGlossiness warning.");
});

// 2. Character & Bone Mapping
loader.load('assets/RiggedFigure.glb', (gltf) => {
    player = gltf.scene;
    player.scale.set(SCALES.player, SCALES.player, SCALES.player);
    scene.add(player);
    
    mixer = new THREE.AnimationMixer(player);
    if(gltf.animations.length > 0) {
        mixer.clipAction(gltf.animations[0]).play(); // Plays 'animation_0'
        log("Playing animation_0");
    }

    // MAP ALL BONES TO CONSOLE
    log("--- STARTING BONE SCAN ---");
    player.traverse(n => {
        if(n.isBone) {
            log(`Found Bone: ${n.name}`);
            // Check for common hand names or generic "node" names
            if(n.name.toLowerCase().includes("hand") || n.name.includes("Bone.007") || n.name.includes("Palm")) {
                handBone = n;
            }
        }
    });
    
    if(handBone) log(`AUTO-ATTACHED TO: ${handBone.name}`);
    else log("NO HAND BONE FOUND. Look at the list above and tell me the name of the hand bone!", true);
});

// 3. Truck
loader.load('assets/low-poly_truck_car_drifter.glb', (gltf) => {
    truck = gltf.scene;
    truck.scale.set(SCALES.truck, SCALES.truck, SCALES.truck);
    truck.position.set(30, 0, 30);
    scene.add(truck);
});

// --- WEAPON SYSTEM ---
window.equip = (name) => {
    Object.values(weaponModels).forEach(w => w.visible = false);
    if(name !== 'fist' && handBone) {
        if(!weaponModels[name]) {
            loader.load(`assets/weapons/${name}.glb`, (wg) => {
                const m = wg.scene;
                m.scale.set(SCALES.weapon, SCALES.weapon, SCALES.weapon);
                m.rotation.x = Math.PI / 2; // Point weapon forward
                handBone.add(m);
                weaponModels[name] = m;
                log(`Weapon ${name} attached to ${handBone.name}`);
            });
        } else {
            weaponModels[name].visible = true;
        }
    }
    document.getElementById('weapon-wheel').style.display = 'none';
};

// --- CONTROLS ---
document.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if(e.key === 'Tab') { e.preventDefault(); document.getElementById('weapon-wheel').style.display = 'flex'; }
    if(e.key === '=') vConsole.style.display = vConsole.style.display === 'none' ? 'block' : 'none';
    if(e.key === 'f') toggleVehicle();
});
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

function toggleVehicle() {
    if(!player || !truck) return;
    const d = player.position.distanceTo(truck.position);
    if(!isDriving && d < 30) { isDriving = true; player.visible = false; }
    else if(isDriving) { isDriving = false; player.visible = true; player.position.set(truck.position.x + 10, 0, truck.position.z); }
}

// --- MAIN LOOP ---
const clock = new THREE.Clock();
function animate() {
    requestAnimationFrame(animate);
    const delta = clock.getDelta();
    if(mixer) mixer.update(delta);

    const target = isDriving ? truck : player;
    if(target) {
        const speed = isDriving ? 1.5 : 0.6;
        if(keys['w']) target.position.z -= speed;
        if(keys['s']) target.position.z += speed;
        if(keys['a']) target.position.x -= speed;
        if(keys['d']) target.position.x += speed;

        camera.position.lerp(new THREE.Vector3(target.position.x, target.position.y + 40, target.position.z + 80), 0.1);
        camera.lookAt(target.position);
    }
    renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
