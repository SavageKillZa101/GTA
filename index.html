<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web GTA: Fix Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #hud { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; text-shadow: 2px 2px #000; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; color: white; display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

<div id="loader"><h1>LOADING ASSETS...</h1></div>
<div id="hud">
    <div id="mph">0 MPH</div>
    <div>F: Enter Truck | M: Respawn Truck</div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import * as CANNON from 'https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js';

// --- 1. THE "NO MORE BLACK SCREEN" SETUP ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB); // Bright sky blue

const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.toneMapping = THREE.ReinhardToneMapping; // Improves lighting colors
document.body.appendChild(renderer.domElement);

// Extreme Lighting (Prevents Black Screen)
const ambient = new THREE.AmbientLight(0xffffff, 2.0); // Very bright ambient
scene.add(ambient);
const sun = new THREE.DirectionalLight(0xffffff, 3.0);
sun.position.set(100, 200, 100);
scene.add(sun);

// --- 2. THE "NO MORE FALLING THROUGH" PHYSICS ---
const world = new CANNON.World();
world.gravity.set(0, -15, 0);

// Thick Floor Physics
const groundBody = new CANNON.Body({ 
    mass: 0, 
    shape: new CANNON.Box(new CANNON.Vec3(500, 1, 500)) // Uses a thick box instead of a thin plane
});
groundBody.position.set(0, -1, 0); 
world.addBody(groundBody);

const playerBody = new CANNON.Body({
    mass: 1,
    shape: new CANNON.Sphere(0.7),
    position: new CANNON.Vec3(0, 15, 0), // Start high up
    fixedRotation: true
});
world.addBody(playerBody);

// --- 3. ASSET LOADING & SCALING ---
const loader = new GLTFLoader();
let playerMesh, truckMesh, cityMesh, mixer;
let isDriving = false;
let activeMesh = null;

// LOAD CITY
loader.load('assets/city/source/scene.gltf', (gltf) => {
    cityMesh = gltf.scene;
    scene.add(cityMesh);
    console.log("City Loaded");
});

// LOAD TRUCK (Fixing the "Massive" size)
loader.load('assets/low-poly_truck_car_drifter.glb', (gltf) => {
    truckMesh = gltf.scene;
    // SHRINK THE TRUCK: If 0.1 is still too big, try 0.01
    truckMesh.scale.set(0.1, 0.1, 0.1); 
    scene.add(truckMesh);
    console.log("Truck Loaded");
});

// LOAD PLAYER
loader.load('assets/RiggedFigure.glb', (gltf) => {
    playerMesh = gltf.scene;
    playerMesh.scale.set(1, 1, 1);
    scene.add(playerMesh);
    activeMesh = playerMesh;
    
    // Animation
    mixer = new THREE.AnimationMixer(playerMesh);
    if(gltf.animations.length > 0) mixer.clipAction(gltf.animations[0]).play();

    document.getElementById('loader').style.display = 'none';
});

// --- 4. GAME TOOLS ---
const keys = {};
window.onkeydown = (e) => { 
    keys[e.key.toLowerCase()] = true; 
    if(e.key === 'f') toggleVehicle();
    if(e.key === 'm') { // M to Spawn Truck at Feet
        truckMesh.position.set(playerBody.position.x, 2, playerBody.position.z);
    }
};
window.onkeyup = (e) => { keys[e.key.toLowerCase()] = false; };

function toggleVehicle() {
    const d = playerMesh.position.distanceTo(truckMesh.position);
    if(!isDriving && d < 10) {
        isDriving = true; playerMesh.visible = false; activeMesh = truckMesh;
    } else if(isDriving) {
        isDriving = false; playerMesh.visible = true; activeMesh = playerMesh;
        playerBody.position.x += 5;
    }
}

// --- 5. THE LOOP ---
const clock = new THREE.Clock();
function animate() {
    requestAnimationFrame(animate);
    const delta = clock.getDelta();
    world.step(1/60);
    if(mixer) mixer.update(delta);

    if(activeMesh) {
        // Sync Visuals to Physics
        activeMesh.position.set(playerBody.position.x, playerBody.position.y - 0.7, playerBody.position.z);

        // Movement
        const speed = isDriving ? 1.0 : 0.2;
        if(keys['w']) playerBody.position.x += speed;
        if(keys['s']) playerBody.position.x -= speed;
        if(keys['a']) playerBody.position.z -= speed;
        if(keys['d']) playerBody.position.z += speed;

        // Camera Follow
        camera.position.set(playerBody.position.x - 15, playerBody.position.y + 10, playerBody.position.z);
        camera.lookAt(playerBody.position);
    }
    renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
