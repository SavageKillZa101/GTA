<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web GTA - Final Fix</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Courier New', monospace; }
        #hud { position: absolute; top: 10px; left: 10px; color: #fff; pointer-events: none; text-shadow: 2px 2px #000; z-index: 10; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; color: #ffcc00; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #virtual-console { position: absolute; bottom: 0; left: 0; width: 100%; height: 25%; background: rgba(0,0,0,0.8); color: #0f0; overflow-y: auto; display: none; padding: 10px; font-size: 12px; z-index: 1000; border-top: 2px solid #0f0; }
    </style>
</head>
<body>

<div id="loader"><h1>LOADING LOS SANTOS...</h1><p id="load-msg">Checking assets...</p></div>
<div id="virtual-console"><strong>DEBUG LOG (Press = to toggle)</strong><hr></div>

<div id="hud">
    <div style="background: rgba(0,0,0,0.6); padding: 15px; border-radius: 5px;">
        0 MPH<br>
        WASD: Move | F: Enter Truck | M: Respawn Truck | <b>=: Debug Console</b>
    </div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

// --- CONFIG ---
const SCALES = {
    city: 1.0,
    truck: 0.5,  // Adjusted for standard GLB size
    player: 1.0
};

// --- DEBUGGER ---
const vConsole = document.getElementById('virtual-console');
function debugLog(msg, isError = false) {
    const div = document.createElement('div');
    if(isError) div.style.color = "red";
    div.innerText = `> ${msg}`;
    vConsole.appendChild(div);
    console.log(msg);
}

// --- ENGINE ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
document.body.appendChild(renderer.domElement);

const ambient = new THREE.AmbientLight(0xffffff, 2.0);
scene.add(ambient);
const sun = new THREE.DirectionalLight(0xffffff, 2.0);
sun.position.set(50, 100, 50);
scene.add(sun);

const loader = new GLTFLoader();
let player, truck, city, mixer;
let isDriving = false;
const keys = {};

// --- LOADERS (Paths corrected based on your screenshots) ---

// 1. Load City (Project.glb)
loader.load('assets/source/Project.glb', (gltf) => {
    city = gltf.scene;
    scene.add(city);
    debugLog("City (Project.glb) loaded");
}, undefined, (e) => debugLog("FAILED: assets/source/Project.glb not found", true));

// 2. Load Truck
loader.load('assets/low-poly_truck_car_drifter.glb', (gltf) => {
    truck = gltf.scene;
    truck.scale.set(SCALES.truck, SCALES.truck, SCALES.truck);
    truck.position.set(5, 0, 5);
    scene.add(truck);
    debugLog("Truck loaded");
}, undefined, (e) => debugLog("FAILED: assets/low-poly_truck_car_drifter.glb not found", true));

// 3. Load Player
loader.load('assets/RiggedFigure.glb', (gltf) => {
    player = gltf.scene;
    scene.add(player);
    
    mixer = new THREE.AnimationMixer(player);
    if(gltf.animations.length > 0) {
        const action = mixer.clipAction(gltf.animations[0]);
        action.play();
    }
    
    document.getElementById('loader').style.display = 'none';
    debugLog("Player loaded");
}, undefined, (e) => debugLog("FAILED: assets/RiggedFigure.glb not found", true));

// --- LOGIC ---
document.addEventListener('keydown', (e) => {
    keys[e.key.toLowerCase()] = true;
    if(e.key === '=') vConsole.style.display = vConsole.style.display === 'none' ? 'block' : 'none';
    if(e.key.toLowerCase() === 'm' && truck && player) {
        truck.position.set(player.position.x + 2, 0, player.position.z);
        debugLog("Truck teleported to player");
    }
    if(e.key.toLowerCase() === 'f') toggleVehicle();
});
document.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

function toggleVehicle() {
    if(!player || !truck) return;
    const dist = player.position.distanceTo(truck.position);
    if(!isDriving && dist < 5) {
        isDriving = true; player.visible = false;
        debugLog("Driving...");
    } else if(isDriving) {
        isDriving = false; player.visible = true;
        player.position.set(truck.position.x + 2, 0, truck.position.z);
        debugLog("Walking...");
    }
}

function animate() {
    requestAnimationFrame(animate);
    const delta = new THREE.Clock().getDelta();
    if(mixer) mixer.update(0.016); // Standard frame delta

    const target = isDriving ? truck : player;
    if(target) {
        const speed = isDriving ? 0.5 : 0.15;
        if(keys['w']) target.position.z -= speed;
        if(keys['s']) target.position.z += speed;
        if(keys['a']) target.position.x -= speed;
        if(keys['d']) target.position.x += speed;

        camera.position.lerp(new THREE.Vector3(target.position.x, target.position.y + 10, target.position.z + 20), 0.1);
        camera.lookAt(target.position);
    }
    renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
