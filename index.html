<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GTA Web Prototype</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; user-select: none; }
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Weapon Wheel */
        #weapon-wheel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; background: rgba(0,0,0,0.8); border-radius: 50%;
            display: none; align-items: center; justify-content: center; pointer-events: auto;
        }
        .weapon-slot {
            position: absolute; color: white; font-weight: bold; cursor: pointer;
            padding: 10px; border-radius: 5px; transition: 0.2s;
        }
        .weapon-slot:hover { background: rgba(255,255,255,0.2); color: yellow; }
        .weapon-slot.selected { color: #00ff00; border: 1px solid #00ff00; }
        
        /* Loading Screen */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; color: white; display: flex; 
            align-items: center; justify-content: center; z-index: 999;
        }
    </style>
</head>
<body>

    <div id="loader">Loading Assets...</div>

    <div id="hud">
        <div style="position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.5); padding: 10px;">
            WASD: Move | SPACE: Jump | TAB: Weapons | F: Enter/Exit Car (Concept)
        </div>
        
        <div id="weapon-wheel">
            <div class="weapon-slot" data-weapon="fist" style="top: 20px;">FIST</div>
            <div class="weapon-slot" data-weapon="pistol" style="right: 20px;">PISTOL</div>
            <div class="weapon-slot" data-weapon="rifle" style="bottom: 20px;">RIFLE</div>
            <div class="weapon-slot" data-weapon="rpg" style="left: 20px;">RPG</div>
            <div style="color:gray; font-size: 12px;">CLICK TO SELECT</div>
        </div>
        
        <div id="current-weapon-display" style="position: absolute; top: 20px; right: 20px; color: white; font-size: 24px;">
            WEAPON: FIST
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import * as CANNON from 'https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js';

        // --- SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Physics World
        const world = new CANNON.World();
        world.gravity.set(0, -9.82, 0);

        // --- LOAD ASSETS ---
        const loader = new GLTFLoader();
        let playerMesh, carMesh;
        let activeMesh; // Tracks if we are controlling player or car
        
        // 1. Load City Map
        loader.load('assets/city/city.gltf', (gltf) => {
            const city = gltf.scene;
            city.scale.set(1, 1, 1); // Adjust if city is too big/small
            scene.add(city);
            
            // Auto-generate physics for the city (Simple Plane for now)
            // Ideally, you iterate through city meshes to create physics bodies
        }, undefined, (error) => console.error('An error happened loading city:', error));

        // 2. Load Player (RiggedFigure)
        loader.load('assets/RiggedFigure.glb', (gltf) => {
            playerMesh = gltf.scene;
            playerMesh.scale.set(1, 1, 1); // Adjust scale!
            playerMesh.position.set(0, 0, 0);
            scene.add(playerMesh);
            activeMesh = playerMesh;
            
            // Hide Loader
            document.getElementById('loader').style.display = 'none';
        });

        // 3. Load Car
        loader.load('assets/CarConcept.glb', (gltf) => {
            carMesh = gltf.scene;
            carMesh.scale.set(1, 1, 1); 
            carMesh.position.set(5, 0, 5); // Parked nearby
            scene.add(carMesh);
        });

        // --- PHYSICS BODY (The Player Controller) ---
        const playerBody = new CANNON.Body({
            mass: 50,
            shape: new CANNON.Box(new CANNON.Vec3(0.5, 1, 0.5)),
            position: new CANNON.Vec3(0, 5, 0),
            fixedRotation: true
        });
        world.addBody(playerBody);

        // Ground Physics (Invisible, matches city floor)
        const groundBody = new CANNON.Body({
            type: CANNON.Body.STATIC,
            shape: new CANNON.Plane()
        });
        groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
        world.addBody(groundBody);

        // --- WEAPON WHEEL LOGIC ---
        let currentWeapon = 'fist';
        const slots = document.querySelectorAll('.weapon-slot');

        // Handle Clicking a weapon
        slots.forEach(slot => {
            slot.addEventListener('click', (e) => {
                // 1. Visual update
                slots.forEach(s => s.classList.remove('selected'));
                e.target.classList.add('selected');
                
                // 2. Logic update
                currentWeapon = e.target.getAttribute('data-weapon');
                document.getElementById('current-weapon-display').innerText = "WEAPON: " + currentWeapon.toUpperCase();
                
                // 3. TODO: Attach model logic
                // if(currentWeapon === 'pistol') attachPistolToHand();
            });
        });

        // Toggle Wheel
        let isWheelOpen = false;
        document.addEventListener('keydown', (e) => {
            if(e.key.toLowerCase() === 'tab') {
                e.preventDefault();
                isWheelOpen = true;
                document.getElementById('weapon-wheel').style.display = 'flex';
            }
        });
        document.addEventListener('keyup', (e) => {
            if(e.key.toLowerCase() === 'tab') {
                isWheelOpen = false;
                document.getElementById('weapon-wheel').style.display = 'none';
            }
        });

        // --- GAME LOOP ---
        const keys = { w: false, a: false, s: false, d: false };
        document.addEventListener('keydown', (e) => { if(keys.hasOwnProperty(e.key)) keys[e.key] = true; });
        document.addEventListener('keyup', (e) => { if(keys.hasOwnProperty(e.key)) keys[e.key] = false; });

        function animate() {
            requestAnimationFrame(animate);
            world.step(1/60);

            // Sync physics with active mesh
            if(activeMesh) {
                activeMesh.position.copy(playerBody.position);
                // Lower the mesh slightly so feet touch ground, not center of body
                activeMesh.position.y -= 1; 
                
                // Rotate player mesh to face movement
                if (keys.w || keys.a || keys.s || keys.d) {
                    const angle = Math.atan2(playerBody.velocity.x, playerBody.velocity.z);
                    activeMesh.rotation.y = angle;
                }
            }

            // Movement
            const speed = 10;
            if (keys.w) playerBody.velocity.z = -speed;
            if (keys.s) playerBody.velocity.z = speed;
            if (keys.a) playerBody.velocity.x = -speed;
            if (keys.d) playerBody.velocity.x = speed;
            
            // Friction/Stop
            if (!keys.w && !keys.s) playerBody.velocity.z = 0;
            if (!keys.a && !keys.d) playerBody.velocity.x = 0;

            // Camera Follow
            camera.position.set(playerBody.position.x, playerBody.position.y + 5, playerBody.position.z + 10);
            camera.lookAt(playerBody.position);

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
