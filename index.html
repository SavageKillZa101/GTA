<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web GTA: Truck Edition</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background: #000; }
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; color: white; }
        
        /* Speedometer & UI */
        #ui-container { position: absolute; bottom: 30px; right: 30px; text-align: right; }
        #mph { font-size: 48px; font-weight: 900; font-style: italic; text-shadow: 2px 2px #000; }
        #status { font-size: 18px; color: #00ff00; }

        /* Weapon Wheel */
        #weapon-wheel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 350px; height: 350px; background: rgba(0,0,0,0.85);
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            pointer-events: auto; border: 4px solid #444;
        }
        .slot {
            position: absolute; padding: 15px; cursor: pointer; color: #aaa;
            font-weight: bold; transition: 0.2s; border-radius: 10px;
        }
        .slot:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .slot.active { color: #00ff00; border: 2px solid #00ff00; }

        /* Loading Screen */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
        }
    </style>
</head>
<body>

<div id="loader">
    <h1>LOS SANTOS WEB</h1>
    <p>Loading City & Assets...</p>
</div>

<div id="hud">
    <div style="padding: 20px; background: rgba(0,0,0,0.4); width: fit-content;">
        WASD: Move | <b>F: Enter/Exit Truck</b> | <b>TAB: Weapon Wheel</b>
    </div>
    
    <div id="ui-container">
        <div id="status">WALKING</div>
        <div id="mph">00 MPH</div>
    </div>

    <div id="weapon-wheel">
        <div class="slot active" data-w="fist" style="top: 20px;">FIST</div>
        <div class="slot" data-w="pistol" style="right: 20px;">PISTOL</div>
        <div class="slot" data-w="rifle" style="bottom: 20px;">RIFLE</div>
        <div class="slot" data-w="rpg" style="left: 20px;">RPG</div>
    </div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import * as CANNON from 'https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js';

// --- INITIALIZATION ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

const world = new CANNON.World();
world.gravity.set(0, -9.82, 0);

// Lights
const ambient = new THREE.AmbientLight(0xffffff, 0.7);
scene.add(ambient);
const sun = new THREE.DirectionalLight(0xffffff, 1.2);
sun.position.set(50, 100, 50);
sun.castShadow = true;
scene.add(sun);

// --- PHYSICS FLOOR ---
const groundBody = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
world.addBody(groundBody);

// --- PLAYER PHYSICS ---
const playerBody = new CANNON.Body({
    mass: 1,
    shape: new CANNON.Sphere(0.5),
    position: new CANNON.Vec3(0, 5, 0),
    fixedRotation: true
});
world.addBody(playerBody);

// --- LOADING ASSETS ---
const loader = new GLTFLoader();
let city, playerMesh, truckMesh;
let currentWeapon = 'fist';
let isDriving = false;
let activeMesh = null;

// 1. Load City
loader.load('assets/city/scene.gltf', (gltf) => {
    city = gltf.scene;
    city.scale.set(1, 1, 1); 
    city.position.y = -0.1; // Align with physics floor
    scene.add(city);
});

// 2. Load Person
loader.load('assets/RiggedFigure.glb', (gltf) => {
    playerMesh = gltf.scene;
    scene.add(playerMesh);
    activeMesh = playerMesh;
    document.getElementById('loader').style.display = 'none';
});

// 3. Load Truck
loader.load('assets/low-poly_truck_car_drifter.glb', (gltf) => {
    truckMesh = gltf.scene;
    truckMesh.position.set(5, 0, 5); // Park it nearby
    scene.add(truckMesh);
});

// --- CONTROLS ---
const keys = {};
document.addEventListener('keydown', (e) => { 
    keys[e.key.toLowerCase()] = true; 
    if(e.key === 'Tab') { e.preventDefault(); document.getElementById('weapon-wheel').style.display = 'flex'; }
    if(e.key.toLowerCase() === 'f') toggleVehicle();
});
document.addEventListener('keyup', (e) => { 
    keys[e.key.toLowerCase()] = false; 
    if(e.key === 'Tab') document.getElementById('weapon-wheel').style.display = 'none';
});

// Weapon Selection Logic
document.querySelectorAll('.slot').forEach(slot => {
    slot.onclick = () => {
        document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
        slot.classList.add('active');
        currentWeapon = slot.dataset.w;
        console.log("Equipped:", currentWeapon);
    };
});

function toggleVehicle() {
    const dist = playerMesh.position.distanceTo(truckMesh.position);
    if (!isDriving && dist < 4) {
        isDriving = true;
        playerMesh.visible = false;
        activeMesh = truckMesh;
        document.getElementById('status').innerText = "DRIVING";
    } else if (isDriving) {
        isDriving = false;
        playerMesh.visible = true;
        activeMesh = playerMesh;
        playerBody.position.set(truckMesh.position.x + 2, 1, truckMesh.position.z);
        document.getElementById('status').innerText = "WALKING";
    }
}

// --- GAME LOOP ---
function animate() {
    requestAnimationFrame(animate);
    world.step(1/60);

    if (activeMesh) {
        // Match 3D model to Physics position
        if (isDriving) {
            truckMesh.position.copy(playerBody.position);
            // Simple rotation for car
            if(keys.a) truckMesh.rotation.y += 0.05;
            if(keys.d) truckMesh.rotation.y -= 0.05;
        } else {
            playerMesh.position.copy(playerBody.position);
            playerMesh.position.y -= 0.5; // Offset for sphere center
        }

        // Movement Logic
        const moveSpeed = isDriving ? 0.5 : 0.15;
        const dir = new THREE.Vector3();
        camera.getWorldDirection(dir);
        dir.y = 0;
        dir.normalize();

        if (keys.w) {
            playerBody.position.x += dir.x * moveSpeed;
            playerBody.position.z += dir.z * moveSpeed;
            if(!isDriving) activeMesh.rotation.y = Math.atan2(dir.x, dir.z);
        }
        if (keys.s) {
            playerBody.position.x -= dir.x * moveSpeed;
            playerBody.position.z -= dir.z * moveSpeed;
        }

        // HUD Update
        const velocity = Math.sqrt(playerBody.velocity.x**2 + playerBody.velocity.z**2);
        document.getElementById('mph').innerText = Math.round(velocity * 2.2) + " MPH";

        // Camera Follow
        const camOffset = isDriving ? new THREE.Vector3(0, 6, 12) : new THREE.Vector3(0, 3, 6);
        const targetPos = playerBody.position;
        camera.position.lerp(new THREE.Vector3(targetPos.x, targetPos.y + camOffset.y, targetPos.z + camOffset.z), 0.1);
        camera.lookAt(targetPos.x, targetPos.y, targetPos.z);
    }

    renderer.render(scene, camera);
}

animate();

// Resize handling
window.onresize = () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
};
</script>
</body>
</html>
