<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web GTA - Combat Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: monospace; }
        #hud { position: absolute; top: 10px; left: 10px; color: #fff; pointer-events: none; z-index: 10; }
        #weapon-wheel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; background: radial-gradient(circle, rgba(0,0,0,0.8), transparent);
            border-radius: 50%; display: none; align-items: center; justify-content: center; z-index: 2000;
        }
        .weapon-slot { position: absolute; color: #aaa; font-weight: bold; cursor: pointer; pointer-events: auto; padding: 10px; transition: 0.2s; }
        .weapon-slot:hover { color: #0f0; transform: scale(1.2); }
        .active-weapon { color: #ffcc00 !important; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; border: 1px solid red; border-radius: 50%; transform: translate(-50%, -50%); display: none; }
    </style>
</head>
<body>

<div id="crosshair"></div>
<div id="weapon-wheel">
    <div class="weapon-slot" style="top: 10%;" data-name="fist">FIST</div>
    <div class="weapon-slot" style="right: 10%;" data-name="pistol">PISTOL</div>
    <div class="weapon-slot" style="bottom: 10%;" data-name="m4">M4 RIFLE</div>
    <div class="weapon-slot" style="left: 10%;" data-name="rpg">RPG</div>
</div>

<div id="hud">
    <div style="background: rgba(0,0,0,0.6); padding: 15px; border-radius: 5px;">
        <b>TAB</b>: Weapon Wheel | <b>LMB</b>: Shoot | <b>F</b>: Vehicle
    </div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

// --- ENGINE SETUP ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 2.0));
const sun = new THREE.DirectionalLight(0xffffff, 1.5);
sun.position.set(50, 100, 50);
scene.add(sun);

const loader = new GLTFLoader();
let player, truck, mixer, handBone;
let currentWeapon = null;
let weaponModels = {};
let isDriving = false;
const keys = {};

// --- 1. WEAPON LOADING & ATTACHMENT ---
const weaponNames = ['pistol', 'm4', 'rpg'];

function loadWeapons() {
    weaponNames.forEach(name => {
        loader.load(`assets/weapons/${name}.glb`, (gltf) => {
            const model = gltf.scene;
            model.scale.set(0.4, 0.4, 0.4); // Scale down for hand
            model.visible = false;
            weaponModels[name] = model;
            console.log(`Weapon ${name} loaded`);
        });
    });
}

// Attach weapon to the hand bone
function equipWeapon(name) {
    // Hide all weapons first
    Object.values(weaponModels).forEach(m => m.visible = false);
    
    if (name === 'fist' || !handBone) {
        document.getElementById('crosshair').style.display = 'none';
        return;
    }

    const weapon = weaponModels[name];
    if (weapon) {
        handBone.add(weapon); // This is the magic: nesting the weapon in the hand bone
        weapon.visible = true;
        
        // Manual offset adjustment (Adjust these numbers to fit the grip)
        weapon.position.set(0, 0.1, 0); 
        weapon.rotation.set(Math.PI / 2, 0, 0);
        
        document.getElementById('crosshair').style.display = 'block';
        currentWeapon = name;
    }
}

// --- 2. ASSET LOADING ---
loader.load('assets/source/Project.glb', (gltf) => scene.add(gltf.scene));

loader.load('assets/low-poly_truck_car_drifter.glb', (gltf) => {
    truck = gltf.scene;
    truck.scale.set(0.1, 0.1, 0.1);
    scene.add(truck);
});

loader.load('assets/RiggedFigure.glb', (gltf) => {
    player = gltf.scene;
    scene.add(player);
    
    mixer = new THREE.AnimationMixer(player);
    
    // FIND THE HAND BONE (Check console to see exact name if this fails)
    player.traverse((child) => {
        if (child.isBone && (child.name.includes('Hand') || child.name.includes('RightHand'))) {
            handBone = child;
            console.log("Hand bone found: ", handBone.name);
        }
    });

    loadWeapons();
});

// --- 3. SHOOTING LOGIC ---
function shoot() {
    if (!currentWeapon || isDriving) return;

    // Create a simple bullet (Muzzle flash placeholder)
    const flash = new THREE.Mesh(
        new THREE.SphereGeometry(0.1),
        new THREE.MeshBasicMaterial({ color: 0xffff00 })
    );
    
    const vector = new THREE.Vector3();
    camera.getWorldDirection(vector);
    
    flash.position.copy(player.position).add(new THREE.Vector3(0, 1.5, 0));
    scene.add(flash);
    
    // Quick flash disappearance
    setTimeout(() => scene.remove(flash), 50);

    console.log("BANG! Shot fired with " + currentWeapon);
}

// --- 4. INPUTS ---
document.addEventListener('mousedown', (e) => { if(e.button === 0) shoot(); });

document.addEventListener('keydown', (e) => {
    const k = e.key.toLowerCase();
    keys[k] = true;
    if(k === 'tab') document.getElementById('weapon-wheel').style.display = 'flex';
});

document.addEventListener('keyup', (e) => {
    const k = e.key.toLowerCase();
    keys[k] = false;
    if(k === 'tab') document.getElementById('weapon-wheel').style.display = 'none';
});

// Weapon Wheel Click Handling
document.querySelectorAll('.weapon-slot').forEach(slot => {
    slot.addEventListener('click', () => {
        const weaponName = slot.getAttribute('data-name');
        equipWeapon(weaponName);
        document.querySelectorAll('.weapon-slot').forEach(s => s.classList.remove('active-weapon'));
        slot.classList.add('active-weapon');
    });
});

// --- 5. ANIMATION LOOP ---
function animate() {
    requestAnimationFrame(animate);
    const delta = 0.016;
    if(mixer) mixer.update(delta);

    if (player && !isDriving) {
        const speed = 0.15;
        if(keys['w']) player.position.z -= speed;
        if(keys['s']) player.position.z += speed;
        if(keys['a']) player.position.x -= speed;
        if(keys['d']) player.position.x += speed;

        // Make player look where the camera looks if a weapon is equipped
        if (currentWeapon !== 'fist') {
            player.rotation.y = camera.rotation.y;
        }

        camera.position.lerp(new THREE.Vector3(player.position.x, player.position.y + 5, player.position.z + 10), 0.1);
        camera.lookAt(player.position);
    }
    
    renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
