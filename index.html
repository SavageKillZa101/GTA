<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Open World Prototype</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; user-select: none; }
        
        /* HUD UI */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Minimap */
        #minimap-border {
            position: absolute; bottom: 20px; left: 20px;
            width: 150px; height: 150px;
            border: 3px solid #000; border-radius: 50%;
            background: rgba(0,0,0,0.5); overflow: hidden;
        }
        #minimap-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; }

        /* Vehicle Info */
        #vehicle-info {
            position: absolute; bottom: 20px; right: 20px;
            text-align: right; color: white;
            text-shadow: 1px 1px 0 #000;
        }
        #mph { font-size: 40px; font-weight: bold; font-style: italic; }
        #radio { font-size: 14px; color: #FFA500; }

        /* Wanted Level */
        #wanted-level {
            position: absolute; top: 20px; right: 20px;
            font-size: 30px; color: transparent; text-shadow: 0 0 0 white;
        }
        .star { display: inline-block; color: gray; }
        .star.active { color: red; }

        /* Weapon Wheel */
        #weapon-wheel {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: none; /* Hidden by default */
            align-items: center; justify-content: center;
        }
        .weapon-slot {
            position: absolute; color: white; font-weight: bold;
            cursor: pointer; pointer-events: auto;
        }
        .weapon-slot:hover { color: yellow; }

        /* Instructions */
        #controls-hint {
            position: absolute; top: 10px; left: 10px;
            color: white; background: rgba(0,0,0,0.5); padding: 10px;
        }
    </style>
</head>
<body>

    <div id="hud">
        <div id="controls-hint">
            WASD: Move | SPACE: Jump<br>
            TAB: Weapon Wheel | R: Toggle Radio
        </div>

        <div id="wanted-level">
            <span class="star" id="star1">★</span>
            <span class="star" id="star2">★</span>
            <span class="star" id="star3">★</span>
            <span class="star" id="star4">★</span>
            <span class="star" id="star5">★</span>
        </div>

        <div id="minimap-border">
            <div id="minimap-content">Map Render</div>
        </div>

        <div id="weapon-wheel">
            <div class="weapon-slot" style="top: 20px;">FIST</div>
            <div class="weapon-slot" style="right: 20px;">PISTOL</div>
            <div class="weapon-slot" style="bottom: 20px;">RIFLE</div>
            <div class="weapon-slot" style="left: 20px;">RPG</div>
            <div style="color:white;">HOLD TAB</div>
        </div>

        <div id="vehicle-info">
            <div id="radio">RADIO: OFF</div>
            <div id="mph">0 <span style="font-size:20px">MPH</span></div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import * as CANNON from 'https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js';

        // --- 1. SETUP SCENE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Sky blue
        scene.fog = new THREE.Fog(0x87CEEB, 10, 50);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // --- 2. PHYSICS WORLD ---
        const world = new CANNON.World();
        world.gravity.set(0, -9.82, 0);
        const groundMaterial = new CANNON.Material();
        const playerMaterial = new CANNON.Material();
        const physicsContact = new CANNON.ContactMaterial(groundMaterial, playerMaterial, { friction: 0.0, restitution: 0.3 });
        world.addContactMaterial(physicsContact);

        // Ground Physics
        const groundBody = new CANNON.Body({
            type: CANNON.Body.STATIC,
            shape: new CANNON.Plane(),
            material: groundMaterial
        });
        groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
        world.addBody(groundBody);

        // Ground Visuals
        const groundGeo = new THREE.PlaneGeometry(100, 100);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
        const groundMesh = new THREE.Mesh(groundGeo, groundMat);
        groundMesh.rotation.x = -Math.PI / 2;
        groundMesh.receiveShadow = true;
        scene.add(groundMesh);

        // --- 3. PLAYER (The "Car/Person") ---
        const playerShape = new CANNON.Box(new CANNON.Vec3(0.5, 0.5, 0.5));
        const playerBody = new CANNON.Body({
            mass: 50, // Weight
            shape: playerShape,
            position: new CANNON.Vec3(0, 5, 0),
            material: playerMaterial,
            linearDamping: 0.9 // Air resistance simulation
        });
        world.addBody(playerBody);

        const playerMesh = new THREE.Mesh(
            new THREE.BoxGeometry(1, 1, 1),
            new THREE.MeshStandardMaterial({ color: 0xff0000 })
        );
        playerMesh.castShadow = true;
        scene.add(playerMesh);

        // --- 4. BUILDINGS (Procedural Generation) ---
        for (let i = 0; i < 20; i++) {
            const h = Math.random() * 5 + 2;
            const w = Math.random() * 2 + 1;
            const x = (Math.random() - 0.5) * 80;
            const z = (Math.random() - 0.5) * 80;
            
            // Don't spawn on player
            if(Math.abs(x) < 5 && Math.abs(z) < 5) continue;

            const boxGeo = new THREE.BoxGeometry(w, h, w);
            const boxMat = new THREE.MeshStandardMaterial({ color: 0x888888 });
            const boxMesh = new THREE.Mesh(boxGeo, boxMat);
            boxMesh.position.set(x, h/2, z);
            boxMesh.castShadow = true;
            scene.add(boxMesh);

            // Physics for buildings
            const boxBody = new CANNON.Body({
                type: CANNON.Body.STATIC,
                shape: new CANNON.Box(new CANNON.Vec3(w/2, h/2, w/2)),
                position: new CANNON.Vec3(x, h/2, z)
            });
            world.addBody(boxBody);
        }

        // --- 5. GAME LOGIC & INPUTS ---
        const keys = { w: false, a: false, s: false, d: false, space: false };
        let isRadioOn = false;
        let wantedLevel = 0;

        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (keys.hasOwnProperty(key)) keys[key] = true;
            if (e.code === 'Space') keys.space = true;
            
            // Toggle Weapon Wheel
            if (key === 'tab') {
                e.preventDefault();
                document.getElementById('weapon-wheel').style.display = 'flex';
            }
            // Toggle Radio
            if (key === 'r') {
                toggleRadio();
            }
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (keys.hasOwnProperty(key)) keys[key] = false;
            if (e.code === 'Space') keys.space = false;
            
            if (key === 'tab') {
                document.getElementById('weapon-wheel').style.display = 'none';
            }
        });

        function toggleRadio() {
            isRadioOn = !isRadioOn;
            const stations = ["Los Santos Rock", "Non-Stop Pop", "West Coast Classics"];
            const display = document.getElementById('radio');
            if(isRadioOn) {
                const station = stations[Math.floor(Math.random() * stations.length)];
                display.innerText = "RADIO: " + station;
                // Note: Actual MP3 playback requires hosting files. 
                // var audio = new Audio('song.mp3'); audio.play();
            } else {
                display.innerText = "RADIO: OFF";
            }
        }

        function updateWantedLevel() {
            // Simulation: If speed is high and random chance, increase wanted level
            if(playerBody.velocity.length() > 15 && wantedLevel < 5 && Math.random() > 0.99) {
                wantedLevel++;
                updateStars();
            }
        }

        function updateStars() {
            for(let i=1; i<=5; i++) {
                const star = document.getElementById('star'+i);
                if(i <= wantedLevel) star.classList.add('active');
                else star.classList.remove('active');
            }
        }

        // --- 6. GAME LOOP ---
        const timeStep = 1 / 60;
        const speed = 20;

        function animate() {
            requestAnimationFrame(animate);

            // Physics Step
            world.step(timeStep);

            // Sync Visuals
            playerMesh.position.copy(playerBody.position);
            playerMesh.quaternion.copy(playerBody.quaternion);

            // Movement Logic (Basic Force Application)
            // Camera direction logic
            const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            forward.y = 0;
            forward.normalize();
            const right = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
            right.y = 0;
            right.normalize();

            if (keys.w) playerBody.velocity.z -= speed * timeStep;
            if (keys.s) playerBody.velocity.z += speed * timeStep;
            if (keys.a) playerBody.velocity.x -= speed * timeStep;
            if (keys.d) playerBody.velocity.x += speed * timeStep;
            if (keys.space && Math.abs(playerBody.velocity.y) < 0.1) playerBody.velocity.y = 5;

            // Camera Follow
            camera.position.set(
                playerMesh.position.x, 
                playerMesh.position.y + 5, 
                playerMesh.position.z + 10
            );
            camera.lookAt(playerMesh.position);

            // Calculate MPH
            const vel = playerBody.velocity;
            const speedVal = Math.sqrt(vel.x*vel.x + vel.y*vel.y + vel.z*vel.z);
            document.getElementById('mph').innerHTML = Math.round(speedVal * 2.2) + ' <span style="font-size:20px">MPH</span>';

            updateWantedLevel();
            renderer.render(scene, camera);
        }

        animate();

        // Handle Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
